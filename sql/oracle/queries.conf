# -*- text -*-
#
# sql/oracle/queries.conf -- Oracle configuration for default schema (schema.sql)
#

# Safe characters list for sql queries. Everything else is replaced
# with their mime-encoded equivalents.
# The default list should be ok
#safe_characters = "@abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789.-_: /"

#######################################################################
#  Connection config
#######################################################################
# The Oracle driver uses connection strings in the format:
# (DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=hostname)(PORT=1521))(CONNECT_DATA=(SERVICE_NAME=service)))
#
# or simply: hostname:port/service_name

#######################################################################
#  Query config:  Username
#######################################################################
# This is the username that will get substituted, escaped, and added
# as attribute 'SQL-User-Name'. '%{SQL-User-Name}' should be used below
# everywhere a username substitution is needed so you can be sure
# the username passed from the client is escaped properly.
#
# Uncomment the next line, if you want the sql_user_name to mean:
#
#    Use Stripped-User-Name, if it's there.
#    Else use User-Name, if it's there,
#    Else use hard-coded string "DEFAULT" as the user name.
#sql_user_name = "%{%{Stripped-User-Name}:-%{%{User-Name}:-DEFAULT}}"
#
sql_user_name = "%{User-Name}"

#######################################################################
# Default Profile
#######################################################################
# This is the default profile. It is found in SQL by group membership.
# That means that this query is listed below, in the "authorize {}" section.
#
authorize_group_check_query = "\
    SELECT \
        id, groupname, attribute, \
        Value, op \
    FROM ${groupcheck_table} \
    WHERE groupname = '%{${group_attribute}}' \
    ORDER BY id"

authorize_group_reply_query = "\
    SELECT \
        id, groupname, attribute, \
        Value, op \
    FROM ${groupreply_table} \
    WHERE groupname = '%{${group_attribute}}' \
    ORDER BY id"

#######################################################################
# Authentication Logging Queries
#######################################################################
# postauth_query        - Insert some info after authentication
#######################################################################

postauth_query = "\
    INSERT INTO ${postauth_table} \
        (id, username, pass, reply, authdate) \
    VALUES ( \
        ${postauth_table}_seq.NEXTVAL, \
        '%{SQL-User-Name}', \
        '%{%{User-Password}:-%{Chap-Password}}', \
        '%{reply:Packet-Type}', \
        SYSDATE)"

#######################################################################
# Authentication Query
#######################################################################
# This query is used by the authorize {} section to retrieve
# user authorization information.
#
authorize_check_query = "\
    SELECT \
        id, username, attribute, value, op \
    FROM ${authcheck_table} \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY id"

authorize_reply_query = "\
    SELECT \
        id, username, attribute, value, op \
    FROM ${authreply_table} \
    WHERE username = '%{SQL-User-Name}' \
    ORDER BY id"

# Use this query to fetch group membership for the user
authorize_group_query = "\
    SELECT groupname \
    FROM ${usergroup_table} \
    WHERE username = '%{SQL-User-Name}' "

#######################################################################
# Simultaneous Use Checking Queries
#######################################################################
# simul_count_query     - query for the number of current connections
# simul_verify_query    - query to return details of current connections
#                         for verification
#######################################################################

simul_count_query = "\
    SELECT COUNT(*) \
    FROM ${acct_table1} \
    WHERE username = '%{SQL-User-Name}' \
    AND acctstoptime IS NULL"

simul_verify_query = "\
    SELECT \
        radacctid, acctsessionid, username, nasipaddress, nasportid, \
        framedipaddress, callingstationid, framedprotocol \
    FROM ${acct_table1} \
    WHERE username = '%{SQL-User-Name}' \
    AND acctstoptime IS NULL"

#######################################################################
# Accounting and Post-Auth Queries
#######################################################################
# accounting_onoff_query        - query for Accounting On/Off packets
# accounting_update_query       - query for Accounting update packets
# accounting_start_query        - query for Accounting start packets
# accounting_start_query_alt    - query for Accounting start packets
#                                 (alternate in case first query fails)
# accounting_stop_query         - query for Accounting stop packets
# accounting_stop_query_alt     - query for Accounting start packets
#                                 (alternate in case first query doesn't
#                                 affect any existing rows in the table)
#######################################################################

accounting_onoff_query = "\
    UPDATE ${acct_table1} \
    SET \
        acctstoptime = SYSDATE, \
        acctsessiontime = \
            ROUND((SYSDATE - TO_DATE('%S','J SSSSS')) * 86400), \
        acctterminatecause = '%{Acct-Terminate-Cause}', \
        acctstopdelay = %{%{Acct-Delay-Time}:-0} \
    WHERE acctstoptime IS NULL \
    AND nasipaddress = '%{NAS-IP-Address}' \
    AND acctstarttime <= SYSDATE"

accounting_update_query = "\
    UPDATE ${acct_table1} \
    SET \
        framedipaddress = '%{Framed-IP-Address}', \
        acctsessiontime = '%{Acct-Session-Time}', \
        acctinputoctets = \
            (('%{%{Acct-Input-Gigawords}:-0}' * 4294967296) + \
             '%{%{Acct-Input-Octets}:-0}'), \
        acctoutputoctets = \
            (('%{%{Acct-Output-Gigawords}:-0}' * 4294967296) + \
             '%{%{Acct-Output-Octets}:-0}'), \
        acctupdatetime = SYSDATE \
    WHERE acctsessionid = '%{Acct-Session-Id}' \
    AND username = '%{SQL-User-Name}' \
    AND nasipaddress = '%{NAS-IP-Address}'"

accounting_update_query_alt = "\
    INSERT INTO ${acct_table1} ( \
        radacctid, acctsessionid, acctuniqueid, username, realm, \
        nasipaddress, nasportid, nasporttype, acctstarttime, \
        acctupdatetime, acctsessiontime, acctauthentic, \
        connectinfo_start, acctinputoctets, acctoutputoctets, \
        calledstationid, callingstationid, servicetype, \
        framedprotocol, framedipaddress \
    ) VALUES ( \
        ${acct_table1}_seq.NEXTVAL, \
        '%{Acct-Session-Id}', \
        '%{Acct-Unique-Session-Id}', \
        '%{SQL-User-Name}', \
        '%{Realm}', \
        '%{NAS-IP-Address}', \
        '%{%{NAS-Port}:-%{NAS-Port-Id}}', \
        '%{NAS-Port-Type}', \
        NULL, \
        SYSDATE, \
        '%{Acct-Session-Time}', \
        '%{Acct-Authentic}', \
        '%{Connect-Info}', \
        (('%{%{Acct-Input-Gigawords}:-0}' * 4294967296) + \
         '%{%{Acct-Input-Octets}:-0}'), \
        (('%{%{Acct-Output-Gigawords}:-0}' * 4294967296) + \
         '%{%{Acct-Output-Octets}:-0}'), \
        '%{Called-Station-Id}', \
        '%{Calling-Station-Id}', \
        '%{Service-Type}', \
        '%{Framed-Protocol}', \
        '%{Framed-IP-Address}' \
    )"

accounting_start_query = "\
    INSERT INTO ${acct_table1} ( \
        radacctid, acctsessionid, acctuniqueid, username, realm, \
        nasipaddress, nasportid, nasporttype, acctstarttime, \
        acctupdatetime, acctstoptime, acctsessiontime, acctauthentic, \
        connectinfo_start, connectinfo_stop, acctinputoctets, \
        acctoutputoctets, calledstationid, callingstationid, \
        acctterminatecause, servicetype, framedprotocol, \
        framedipaddress \
    ) VALUES ( \
        ${acct_table1}_seq.NEXTVAL, \
        '%{Acct-Session-Id}', \
        '%{Acct-Unique-Session-Id}', \
        '%{SQL-User-Name}', \
        '%{Realm}', \
        '%{NAS-IP-Address}', \
        '%{%{NAS-Port}:-%{NAS-Port-Id}}', \
        '%{NAS-Port-Type}', \
        SYSDATE, \
        SYSDATE, \
        NULL, \
        '0', \
        '%{Acct-Authentic}', \
        '%{Connect-Info}', \
        '', \
        '0', \
        '0', \
        '%{Called-Station-Id}', \
        '%{Calling-Station-Id}', \
        '', \
        '%{Service-Type}', \
        '%{Framed-Protocol}', \
        '%{Framed-IP-Address}' \
    )"

accounting_start_query_alt = "\
    UPDATE ${acct_table1} \
    SET \
        acctstarttime = SYSDATE, \
        acctupdatetime = SYSDATE, \
        connectinfo_start = '%{Connect-Info}' \
    WHERE acctsessionid = '%{Acct-Session-Id}' \
    AND username = '%{SQL-User-Name}' \
    AND nasipaddress = '%{NAS-IP-Address}'"

accounting_stop_query = "\
    UPDATE ${acct_table2} \
    SET \
        acctstoptime = SYSDATE, \
        acctsessiontime = '%{Acct-Session-Time}', \
        acctinputoctets = \
            (('%{%{Acct-Input-Gigawords}:-0}' * 4294967296) + \
             '%{%{Acct-Input-Octets}:-0}'), \
        acctoutputoctets = \
            (('%{%{Acct-Output-Gigawords}:-0}' * 4294967296) + \
             '%{%{Acct-Output-Octets}:-0}'), \
        acctterminatecause = '%{Acct-Terminate-Cause}', \
        connectinfo_stop = '%{Connect-Info}' \
    WHERE acctsessionid = '%{Acct-Session-Id}' \
    AND username = '%{SQL-User-Name}' \
    AND nasipaddress = '%{NAS-IP-Address}'"

accounting_stop_query_alt = "\
    INSERT INTO ${acct_table2} ( \
        radacctid, acctsessionid, acctuniqueid, username, realm, \
        nasipaddress, nasportid, nasporttype, acctstarttime, \
        acctstoptime, acctsessiontime, acctauthentic, \
        connectinfo_start, connectinfo_stop, acctinputoctets, \
        acctoutputoctets, calledstationid, callingstationid, \
        acctterminatecause, servicetype, framedprotocol, \
        framedipaddress \
    ) VALUES ( \
        ${acct_table2}_seq.NEXTVAL, \
        '%{Acct-Session-Id}', \
        '%{Acct-Unique-Session-Id}', \
        '%{SQL-User-Name}', \
        '%{Realm}', \
        '%{NAS-IP-Address}', \
        '%{%{NAS-Port}:-%{NAS-Port-Id}}', \
        '%{NAS-Port-Type}', \
        NULL, \
        SYSDATE, \
        '%{Acct-Session-Time}', \
        '%{Acct-Authentic}', \
        '', \
        '%{Connect-Info}', \
        (('%{%{Acct-Input-Gigawords}:-0}' * 4294967296) + \
         '%{%{Acct-Input-Octets}:-0}'), \
        (('%{%{Acct-Output-Gigawords}:-0}' * 4294967296) + \
         '%{%{Acct-Output-Octets}:-0}'), \
        '%{Called-Station-Id}', \
        '%{Calling-Station-Id}', \
        '%{Acct-Terminate-Cause}', \
        '%{Service-Type}', \
        '%{Framed-Protocol}', \
        '%{Framed-IP-Address}' \
    )"

#######################################################################
# Group Membership Queries
#######################################################################
# group_membership_query        - Check user group membership
#######################################################################

group_membership_query = "\
    SELECT groupname \
    FROM ${usergroup_table} \
    WHERE username = '%{SQL-User-Name}' "

#######################################################################
# NAS Query
#######################################################################
# This query retrieves the radius clients (NAS) from the database.
#
client_query = "\
    SELECT \
        id, nasname, shortname, type, secret, server \
    FROM ${client_table}"

#######################################################################
# Deletion Query
#######################################################################
# This query is used to delete old sessions from the database
# (used by radclient or cleanup scripts)
#
delete_stale_sessions_query = "\
    DELETE FROM ${acct_table1} \
    WHERE acctstoptime IS NULL \
    AND (acctstarttime + INTERVAL '%{%{Tmp-Integer-9}:-86400}' SECOND) < SYSDATE"
